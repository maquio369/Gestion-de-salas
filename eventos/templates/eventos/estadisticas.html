{% extends 'eventos/base.html' %}

{% block title %}Estad√≠sticas{% endblock %}

{% block extrahead %}
<style>
  main {
    max-width: 1200px !important;
    margin: 20px auto !important;
    padding: 0 20px !important;
  }
  
  h1 {
    text-align: center;
    color: #009885;
    font-size: 2.2em;
    margin-bottom: 30px;
    font-weight: 600;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .stat-title {
    margin: 0 0 15px 0;
    font-size: 1.1em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  
  .summary-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid;
  }
  
  .summary-card.total { border-left-color: #009885; }
  .summary-card.programado { border-left-color: #0052cc; }
  .summary-card.finalizado { border-left-color: #6c757d; }
  .summary-card.activo { border-left-color: #ff6b35; }
  
  .summary-number {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .summary-label {
    color: #666;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .summary-cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
{% endblock %}

{% block content %}
<h1>üìà Estad√≠sticas de Eventos</h1>

<!-- Resumen de la semana -->
<div class="summary-cards">
  <div class="summary-card total">
    <div class="summary-number" style="color: #009885;">{{ total_eventos_semana }}</div>
    <div class="summary-label">Total Semana</div>
  </div>
  <div class="summary-card programado">
    <div class="summary-number" style="color: #0052cc;">{{ estados_count.programado }}</div>
    <div class="summary-label">Programados</div>
  </div>
  <div class="summary-card finalizado">
    <div class="summary-number" style="color: #6c757d;">{{ estados_count.finalizado }}</div>
    <div class="summary-label">Finalizados</div>
  </div>
  <div class="summary-card activo">
    <div class="summary-number" style="color: #ff6b35;">{{ estados_count.activo }}</div>
    <div class="summary-label">Activos</div>
  </div>
</div>

<!-- Gr√°ficas -->
<div class="stats-grid">
  <div class="stat-card">
    <h3 class="stat-title" style="color: #009885;">üìä Eventos por D√≠a de la Semana</h3>
    <div id="grafico-semana" style="height: 350px;"></div>
  </div>
  
  <div class="stat-card">
    <h3 class="stat-title" style="color: #C90166;">ü•ß Estados de Eventos</h3>
    <div id="grafico-estados" style="height: 350px;"></div>
  </div>
  
  <div class="stat-card">
    <h3 class="stat-title" style="color: #AE192D;">üè¢ Eventos por Sala</h3>
    <div id="grafico-salas" style="height: 350px;"></div>
  </div>
</div>

<script>
// Gr√°fico de eventos por d√≠a de la semana
const diasSemana = {{ dias_semana|safe }};
const eventosPorDia = {{ eventos_por_dia|safe }};

const dataSemana = [{
    x: diasSemana,
    y: eventosPorDia,
    type: 'bar',
    marker: {
        color: ['#009885', '#00a693', '#00b4a1', '#00c2af', '#00d0bd', '#00decb', '#00ecd9'],
        line: {
            color: '#007a6b',
            width: 1
        }
    },
    text: eventosPorDia.map(val => val + ' eventos'),
    textposition: 'auto',
    hovertemplate: '<b>%{x}</b><br>Eventos: %{y}<extra></extra>'
}];

const layoutSemana = {
    margin: { t: 10, r: 10, b: 50, l: 40 },
    font: { family: 'Segoe UI, sans-serif', size: 12 },
    xaxis: { 
        title: '',
        tickangle: -45
    },
    yaxis: { 
        title: 'N√∫mero de Eventos',
        dtick: 1
    },
    plot_bgcolor: 'rgba(0,0,0,0)',
    paper_bgcolor: 'rgba(0,0,0,0)'
};

Plotly.newPlot('grafico-semana', dataSemana, layoutSemana, {
    responsive: true,
    displayModeBar: false
});

// Gr√°fico de estados de eventos
const estadosData = {{ estados_count|safe }};
const estadosLabels = ['Programado', 'Activo', 'Finalizado', 'Cancelado'];
const estadosValues = [estadosData.programado, estadosData.activo, estadosData.finalizado, estadosData.cancelado];
const estadosColors = ['#0052cc', '#ff6b35', '#6c757d', '#dc3545'];

// Filtrar solo estados con valores > 0
const estadosFiltrados = estadosLabels.filter((label, index) => estadosValues[index] > 0);
const valoresFiltrados = estadosValues.filter(value => value > 0);
const coloresFiltrados = estadosColors.filter((color, index) => estadosValues[index] > 0);

if (valoresFiltrados.length > 0) {
    const dataEstados = [{
        labels: estadosFiltrados,
        values: valoresFiltrados,
        type: 'pie',
        marker: {
            colors: coloresFiltrados,
            line: {
                color: '#ffffff',
                width: 2
            }
        },
        textinfo: 'label+percent+value',
        textposition: 'auto',
        hovertemplate: '<b>%{label}</b><br>Eventos: %{value}<br>Porcentaje: %{percent}<extra></extra>'
    }];
    
    const layoutEstados = {
        margin: { t: 10, r: 10, b: 10, l: 10 },
        font: { family: 'Segoe UI, sans-serif', size: 12 },
        showlegend: true,
        legend: {
            orientation: 'v',
            x: 1,
            y: 0.5
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)'
    };
    
    Plotly.newPlot('grafico-estados', dataEstados, layoutEstados, {
        responsive: true,
        displayModeBar: false
    });
} else {
    document.getElementById('grafico-estados').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #8993a4; font-style: italic;">No hay eventos esta semana</div>';
}

// Gr√°fico de eventos por sala
const eventosPorSala = {{ eventos_por_sala|safe }};

if (eventosPorSala.length > 0) {
    const salaNames = eventosPorSala.map(item => item.sala__nombre);
    const salaCounts = eventosPorSala.map(item => item.total);
    
    const dataSalas = [{
        x: salaNames,
        y: salaCounts,
        type: 'bar',
        marker: {
            color: '#AE192D',
            line: {
                color: '#8B1538',
                width: 1
            }
        },
        text: salaCounts.map(val => val + ' eventos'),
        textposition: 'auto',
        hovertemplate: '<b>%{x}</b><br>Eventos: %{y}<extra></extra>'
    }];
    
    const layoutSalas = {
        margin: { t: 10, r: 10, b: 50, l: 40 },
        font: { family: 'Segoe UI, sans-serif', size: 12 },
        xaxis: { 
            title: '',
            tickangle: -45
        },
        yaxis: { 
            title: 'N√∫mero de Eventos',
            dtick: 1
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)'
    };
    
    Plotly.newPlot('grafico-salas', dataSalas, layoutSalas, {
        responsive: true,
        displayModeBar: false
    });
} else {
    document.getElementById('grafico-salas').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #8993a4; font-style: italic;">No hay eventos esta semana</div>';
}
</script>
{% endblock %}